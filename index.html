<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>HamsterSteam Mini App</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
        body{background:radial-gradient(circle at top,#1c67ff,#020617 60%);color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center}
        .app{width:100%;max-width:430px;height:100vh;max-height:820px;background:rgba(15,23,42,.98);border-radius:24px;box-shadow:0 20px 40px rgba(0,0,0,.6);padding:16px 16px 10px;display:flex;flex-direction:column}
        .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
        .logo{display:flex;flex-direction:column;gap:2px}
        .logo-row{display:flex;align-items:center;gap:8px}
        .logo span.coin{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,#a855f7,#6366f1);display:inline-flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 0 12px rgba(129,140,248,.9)}
        .logo-title{font-weight:700;font-size:18px}
        .level-pill{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:999px;background:rgba(15,23,42,.9);font-size:12px}
        .level-pill span.num{font-weight:700;color:#a5b4fc}
        .balance{text-align:right}
        .balance-main{font-size:20px;font-weight:700}
        .balance-sub{font-size:11px;opacity:.8;line-height:1.2}
        .content{flex:1;display:flex;flex-direction:column;align-items:center;padding:4px 4px 0}
        .hamster-zone{margin-top:4px;margin-bottom:8px;display:flex;flex-direction:column;align-items:center;gap:8px}
        .hamster-wrapper{position:relative;width:220px;height:220px;border-radius:999px;background:radial-gradient(circle at 30% 20%,#4c1d95,#111827);overflow:hidden;transition:transform .08s ease}
        .hamster-wrapper.hit{transform:scale(1.04)}
        .hamster-wrapper img{width:100%;height:100%;object-fit:cover;border-radius:50%}
        .ring{position:absolute;inset:10px;border-radius:999px;border:4px solid rgba(129,140,248,.9);border-top-color:transparent;animation:spin 2s linear infinite;pointer-events:none}
        @keyframes spin{to{transform:rotate(360deg)}}
        .float-coin{position:absolute;color:#facc15;font-weight:700;font-size:14px;text-shadow:0 0 6px rgba(0,0,0,.8);pointer-events:none;animation:floatUp .7s ease-out forwards}
        @keyframes floatUp{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-40px)}}
        .stats-small{display:flex;flex-direction:column;gap:3px;font-size:13px;text-align:center}
        .green-tag{display:inline-block;padding:4px 10px;border-radius:999px;background:#22c55e;color:#022c22;font-weight:700;font-size:12px;box-shadow:0 4px 12px rgba(34,197,94,.6)}
        .energy-bar-wrap{width:100%;max-width:260px;margin:4px auto 0}
        .energy-row{display:flex;justify-content:space-between;font-size:12px;opacity:.9;margin-bottom:2px}
        .energy-bar{width:100%;height:8px;border-radius:999px;background:rgba(15,23,42,.9);overflow:hidden}
        .energy-bar-fill{height:100%;width:100%;background:linear-gradient(90deg,#f97316,#facc15);transition:width .15s ease-out}
        .click-btn{width:100%;max-width:280px;margin-top:10px;padding:14px;border-radius:999px;border:none;font-size:16px;font-weight:600;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;cursor:pointer;box-shadow:0 10px 25px rgba(22,163,74,.7);transition:transform .08s ease,box-shadow .1s ease,filter .15s ease}
        .click-btn:active{transform:scale(.97) translateY(1px);box-shadow:0 6px 20px rgba(22,163,74,.9);filter:brightness(1.05)}
        .click-btn.disabled{background:linear-gradient(135deg,#4b5563,#374151);box-shadow:0 4px 12px rgba(15,23,42,.9);cursor:default}
        .tabs{margin-top:8px;width:100%;max-width:360px;display:flex;justify-content:space-between;background:rgba(15,23,42,.96);border-radius:16px;padding:4px}
        .tab-btn{flex:1;padding:8px 4px;margin:0 2px;border-radius:12px;border:none;background:transparent;color:#9ca3af;font-size:11px;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer}
        .tab-btn span.icon{font-size:16px}
        .tab-btn.active{background:rgba(55,65,81,.9);color:#f9fafb}
        .panel{width:100%;max-width:360px;margin-top:8px;padding:10px;border-radius:16px;background:rgba(15,23,42,.96);font-size:13px}
        .panel.hidden{display:none}
        .panel-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
        .back-btn{width:28px;height:28px;border-radius:999px;border:none;background:rgba(31,41,55,0.95);color:#e5e7eb;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer}
        .panel-title{font-weight:600;font-size:14px}
        .panel-subtitle{font-size:11px;opacity:0.7;margin-top:2px}
        .upgrade-item,.quest-item,.farm-item,.ach-item,.steam-item{display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid rgba(55,65,81,.7)}
        .upgrade-item:last-child,.quest-item:last-child,.farm-item:last-child,.ach-item:last-child,.steam-item:last-child{border-bottom:none}
        .upgrade-main,.quest-main,.farm-main,.ach-main,.steam-main{display:flex;flex-direction:column;gap:2px}
        .upgrade-title,.quest-title,.farm-title,.ach-title,.steam-title{font-weight:600}
        .upgrade-desc,.quest-desc,.farm-desc,.ach-desc,.steam-desc{font-size:11px;opacity:.8}
        .upgrade-meta,.quest-meta,.farm-meta,.ach-meta,.steam-meta{font-size:11px;opacity:.9}
        .btn-pill{padding:6px 10px;border-radius:999px;border:none;background:linear-gradient(135deg,#facc15,#f97316);color:#111827;font-weight:600;font-size:11px;cursor:pointer;white-space:nowrap}
        .btn-pill.disabled{background:#4b5563;color:#e5e7eb;cursor:default}
        .ach-badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.8);opacity:.85}
        .ach-badge.done{border-color:#22c55e;color:#bbf7d0}
        .progress{width:100%;height:6px;border-radius:999px;background:#020617;margin-top:4px;overflow:hidden}
        .progress-fill{height:100%;width:0;border-radius:999px;background:linear-gradient(90deg,#22c55e,#a3e635);transition:width .2s}
        .ref-link{font-size:11px;word-break:break-all;margin-top:4px;opacity:.8}
        .footer{margin-top:6px;font-size:11px;opacity:.6;text-align:center}
    </style>
</head>
<body>
<div class="app">
    <div class="header">
        <div class="logo">
            <div class="logo-row">
                <span class="coin">S</span>
                <span class="logo-title">HamsterSteam</span>
            </div>
            <div class="level-pill">
                –£—Ä–æ–≤–µ–Ω—å <span class="num" id="level-label">1</span>
            </div>
        </div>
        <div class="balance">
            <div class="balance-main" id="coins-label">0</div>
            <div class="balance-sub" id="income-label">1 –∑–∞ –∫–ª–∏–∫ ¬∑ 1 –≤ —Å–µ–∫—É–Ω–¥—É</div>
        </div>
    </div>

    <div class="content">
        <!-- –≥–ª–∞–≤–Ω–∞—è –∑–æ–Ω–∞ (—Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –£–ª—É—á—à–µ–Ω–∏—è) -->
        <div class="hamster-zone" id="hamster-zone">
            <div class="hamster-wrapper" id="hamster-wrapper">
                <!-- –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å–æ Steam –ª–æ–≥–æ—Ç–∏–ø–æ–º; —Ñ–∞–π–ª steam_logo.png –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å index.html -->
                <img src="steam_logo.png" alt="Steam hamster logo">
                <div class="ring"></div>
            </div>

            <div class="stats-small">
                <span class="green-tag" id="green-info">1 –∑–∞ –∫–ª–∏–∫ ¬∑ 1 –≤ —Å–µ–∫—É–Ω–¥—É</span>
                <span id="user-label" style="opacity:.8;font-size:12px;">–ì–æ—Å—Ç—å</span>
            </div>

            <div class="energy-bar-wrap">
                <div class="energy-row">
                    <span>‚ö° –≠–Ω–µ—Ä–≥–∏—è</span>
                    <span id="energy-label">10 / 10</span>
                </div>
                <div class="energy-bar">
                    <div class="energy-bar-fill" id="energy-fill" style="width:100%;"></div>
                </div>
            </div>

            <button class="click-btn" id="click-btn">–ö–ª–∏–∫–Ω—É—Ç—å üí∏</button>
        </div>

        <!-- –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="upgrades">
                <span class="icon">‚¨ÜÔ∏è</span> –£–ª—É—á—à–µ–Ω–∏—è
            </button>
            <button class="tab-btn" data-tab="farm">
                <span class="icon">üåæ</span> –§–µ—Ä–º–∞
            </button>
            <button class="tab-btn" data-tab="invites">
                <span class="icon">üë•</span> –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
            </button>
            <button class="tab-btn" data-tab="achievements">
                <span class="icon">üèÜ</span> –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            </button>
            <button class="tab-btn" data-tab="quests">
                <span class="icon">üìã</span> –ó–∞–¥–∞–Ω–∏—è
            </button>
        </div>

        <!-- —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
        <!-- –£–ª—É—á—à–µ–Ω–∏—è -->
        <div class="panel" id="panel-upgrades">
            <div class="upgrade-item">
                <div class="upgrade-main">
                    <div class="upgrade-title">–≠–Ω–µ—Ä–≥–∏—è</div>
                    <div class="upgrade-desc">–ë–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏ –∏ –ø–æ–ª–Ω—ã–π –∑–∞—Ä—è–¥.</div>
                    <div class="upgrade-meta" id="energy-meta">–£—Ä–æ–≤–µ–Ω—å 1 ¬∑ 10 —ç–Ω–µ—Ä–≥–∏–∏</div>
                </div>
                <button class="btn-pill" id="btn-upg-energy">–ö—É–ø–∏—Ç—å</button>
            </div>

            <div class="upgrade-item">
                <div class="upgrade-main">
                    <div class="upgrade-title">–ú–æ–Ω–µ—Ç—ã –∑–∞ –∫–ª–∏–∫</div>
                    <div class="upgrade-desc">–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∑–∞—Ä–∞–±–æ—Ç–æ–∫ –∑–∞ –∫–ª–∏–∫.</div>
                    <div class="upgrade-meta" id="click-meta">–£—Ä–æ–≤–µ–Ω—å 1 ¬∑ 1 –∑–∞ –∫–ª–∏–∫</div>
                </div>
                <button class="btn-pill" id="btn-upg-click">–ö—É–ø–∏—Ç—å</button>
            </div>

            <div class="upgrade-item">
                <div class="upgrade-main">
                    <div class="upgrade-title">–ê–≤—Ç–æ-–∫–ª–∏–∫</div>
                    <div class="upgrade-desc">–ë–∞–∑–æ–≤—ã–π –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É.</div>
                    <div class="upgrade-meta" id="auto-meta">–£—Ä–æ–≤–µ–Ω—å 1 ¬∑ 1 –≤ —Å–µ–∫—É–Ω–¥—É</div>
                </div>
                <button class="btn-pill" id="btn-upg-auto">–ö—É–ø–∏—Ç—å</button>
            </div>

            <div class="upgrade-item">
                <div class="upgrade-main">
                    <div class="upgrade-title">–†–µ–≥–µ–Ω —ç–Ω–µ—Ä–≥–∏–∏</div>
                    <div class="upgrade-desc">–ë—ã—Å—Ç—Ä–µ–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —ç–Ω–µ—Ä–≥–∏—è.</div>
                    <div class="upgrade-meta" id="regen-meta">–£—Ä–æ–≤–µ–Ω—å 1 ¬∑ 1.0 ‚ö°/—Å–µ–∫</div>
                </div>
                <button class="btn-pill" id="btn-upg-regen">–ö—É–ø–∏—Ç—å</button>
            </div>

            <div class="upgrade-item">
                <div class="upgrade-main">
                    <div class="upgrade-title">–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Ñ–∏–ª—è</div>
                    <div class="upgrade-desc">–û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –±–æ–Ω—É—Å—ã.</div>
                    <div class="upgrade-meta" id="level-meta">–£—Ä–æ–≤–µ–Ω—å 1 ¬∑ —Å–ª–µ–¥. 1000 –º–æ–Ω–µ—Ç</div>
                </div>
                <button class="btn-pill" id="btn-upg-level">–ü–æ–≤—ã—Å–∏—Ç—å</button>
            </div>

            <!-- STEAM –í–´–í–û–î -->
            <div class="steam-item">
                <div class="steam-main">
                    <div class="steam-title">Steam —Ä—É–±–ª–∏</div>
                    <div class="steam-desc">10 000 000 –º–æ–Ω–µ—Ç = 1‚ÇΩ. –í—ã–≤–æ–¥ —Å 100‚ÇΩ.</div>
                    <div class="steam-meta" id="steam-meta">–ë–∞–ª–∞–Ω—Å Steam: 0‚ÇΩ ¬∑ –¥–æ—Å—Ç—É–ø–Ω–æ 0‚ÇΩ</div>
                </div>
                <button class="btn-pill" id="btn-steam-cashout">–í—ã–≤–µ—Å—Ç–∏</button>
            </div>
        </div>

        <!-- –§–µ—Ä–º–∞ -->
        <div class="panel hidden" id="panel-farm">
            <div class="panel-header">
                <button class="back-btn" data-back="upgrades">‚Üê</button>
                <div>
                    <div class="panel-title">–§–µ—Ä–º–∞</div>
                    <div class="panel-subtitle">–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä</div>
                </div>
            </div>
            <div id="farm-list"></div>
        </div>

        <!-- –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è -->
        <div class="panel hidden" id="panel-invites">
            <div class="panel-header">
                <button class="back-btn" data-back="upgrades">‚Üê</button>
                <div>
                    <div class="panel-title">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</div>
                    <div class="panel-subtitle">–ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –¥—Ä—É–≥ –¥–∞—ë—Ç 10 000 –º–æ–Ω–µ—Ç</div>
                </div>
            </div>
            <div class="steam-desc">
                –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É —Å—Å—ã–ª–∫—É –Ω–∏–∂–µ. –ï—Å–ª–∏ –æ–Ω –∑–∞–π–¥—ë—Ç –≤ –±–æ—Ç–∞ –ø–æ –Ω–µ–π –∏ –Ω–∞–∂–º—ë—Ç –∫–Ω–æ–ø–∫—É
                ¬´–û—Ç–∫—Ä—ã—Ç—å –∏–≥—Ä—É¬ª, –≤—ã –æ–±–∞ –ø–æ–ª—É—á–∏—Ç–µ –ø–æ 10 000 –º–æ–Ω–µ—Ç.
            </div>
            <div class="ref-link" id="ref-link"></div>
        </div>

        <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
        <div class="panel hidden" id="panel-achievements">
            <div class="panel-header">
                <button class="back-btn" data-back="upgrades">‚Üê</button>
                <div>
                    <div class="panel-title">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
                    <div class="panel-subtitle">–°–æ–±–µ—Ä–∏ –≤—Å–µ –Ω–∞–≥—Ä–∞–¥—ã</div>
                </div>
            </div>
            <div id="ach-list"></div>
        </div>

        <!-- –ó–∞–¥–∞–Ω–∏—è -->
        <div class="panel hidden" id="panel-quests">
            <div class="panel-header">
                <button class="back-btn" data-back="upgrades">‚Üê</button>
                <div>
                    <div class="panel-title">–ó–∞–¥–∞–Ω–∏—è</div>
                    <div class="panel-subtitle">–í—ã–ø–æ–ª–Ω—è–π –∏ –∑–∞–±–∏—Ä–∞–π –Ω–∞–≥—Ä–∞–¥—ã</div>
                </div>
            </div>
            <div id="quest-list"></div>
        </div>
    </div>

    <div class="footer">
        –ü—Ä–æ–≥—Ä–µ—Å—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–ø–æ Telegram-ID)
    </div>
</div>

<script>
    // === –ù–ê–°–¢–†–û–ô–ö–ò API ===
    const API_BASE = "https://farmsteam-backend.onrender.com"; // URL FastAPI
    const BOT_USERNAME = "STfarmRub_bot";            // –±–µ–∑ @

    // === –ê–Ω—Ç–∏-double-tap zoom ===
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, {passive: false});

    const tg = window.Telegram?.WebApp;
    if (tg) {
        tg.ready();
        tg.expand();
        document.body.style.backgroundColor = tg.themeParams.bg_color || "#020617";
    }

    const clickBtn = document.getElementById("click-btn");
    const coinsLabel = document.getElementById("coins-label");
    const incomeLabel = document.getElementById("income-label");
    const greenInfo = document.getElementById("green-info");
    const userLabel = document.getElementById("user-label");
    const energyLabel = document.getElementById("energy-label");
    const energyFill = document.getElementById("energy-fill");
    const hamsterWrapper = document.getElementById("hamster-wrapper");
    const hamsterZone = document.getElementById("hamster-zone");
    const levelLabel = document.getElementById("level-label");
    const levelMeta = document.getElementById("level-meta");
    const steamMeta = document.getElementById("steam-meta");
    const refLinkEl = document.getElementById("ref-link");

    const energyMeta = document.getElementById("energy-meta");
    const clickMeta = document.getElementById("click-meta");
    const autoMeta = document.getElementById("auto-meta");
    const regenMeta = document.getElementById("regen-meta");

    const btnUpgEnergy = document.getElementById("btn-upg-energy");
    const btnUpgClick = document.getElementById("btn-upg-click");
    const btnUpgAuto = document.getElementById("btn-upg-auto");
    const btnUpgRegen = document.getElementById("btn-upg-regen");
    const btnUpgLevel = document.getElementById("btn-upg-level");
    const btnSteamCashout = document.getElementById("btn-steam-cashout");

    const farmList = document.getElementById("farm-list");
    const questList = document.getElementById("quest-list");
    const achList   = document.getElementById("ach-list");

    const tabButtons = document.querySelectorAll(".tab-btn");
    const panels = {
        upgrades: document.getElementById("panel-upgrades"),
        farm: document.getElementById("panel-farm"),
        invites: document.getElementById("panel-invites"),
        achievements: document.getElementById("panel-achievements"),
        quests: document.getElementById("panel-quests")
    };
    const backButtons = document.querySelectorAll(".back-btn");

    let userId = "guest";
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        const u = tg.initDataUnsafe.user;
        userId = String(u.id);
        userLabel.textContent = `${u.first_name || "–ò–≥—Ä–æ–∫"} ¬∑ ID ${u.id}`;
    }

    const FARM_DEFS = [
        {id:"cage",   title:"–ö–ª–µ—Ç–∫–∞",         desc:"+2 –≤ —Å–µ–∫—É–Ω–¥—É –∑–∞ —É—Ä–æ–≤–µ–Ω—å",   baseIncome:2,   baseCost:200},
        {id:"office", title:"–•–æ–º—è–∫-–æ—Ñ–∏—Å",     desc:"+5 –≤ —Å–µ–∫—É–Ω–¥—É –∑–∞ —É—Ä–æ–≤–µ–Ω—å",   baseIncome:5,   baseCost:800},
        {id:"stock",  title:"–•–æ–º—è–∫-–±–∏—Ä–∂–∞",    desc:"+12 –≤ —Å–µ–∫—É–Ω–¥—É –∑–∞ —É—Ä–æ–≤–µ–Ω—å",  baseIncome:12,  baseCost:2500},
        {id:"crypto", title:"–ö—Ä–∏–ø—Ç–æ-—Ñ–µ—Ä–º–∞",   desc:"+30 –≤ —Å–µ–∫—É–Ω–¥—É –∑–∞ —É—Ä–æ–≤–µ–Ω—å",  baseIncome:30,  baseCost:8000},
        {id:"orbita", title:"–û—Ä–±–∏—Ç. —Å—Ç–∞–Ω—Ü–∏—è", desc:"+80 –≤ —Å–µ–∫—É–Ω–¥—É –∑–∞ —É—Ä–æ–≤–µ–Ω—å",  baseIncome:80,  baseCost:20000},
    ];

    const QUEST_DEFS = [
        {id:"clicks50",  title:"–°–¥–µ–ª–∞–π 50 –∫–ª–∏–∫–æ–≤",    desc:"–ù–∞–∂–∏–º–∞–π –ø–æ –ª–æ–≥–æ—Ç–∏–ø—É",       reward:200,  target:50,  type:"clicks"},
        {id:"coins1000", title:"–ù–∞–∫–æ–ø–∏ 1000 –º–æ–Ω–µ—Ç",   desc:"–î–æ—Å—Ç–∏–≥–Ω–∏ –±–∞–ª–∞–Ω—Å–∞ 1000",    reward:500,  target:1000,type:"coins"},
        {id:"passive20", title:"20 –º–æ–Ω–µ—Ç/—Å–µ–∫—É–Ω–¥—É",    desc:"–†–∞–∑–≥–æ–Ω–∏ –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥",  reward:800,  target:20,  type:"auto"},
    ];

    const ACH_DEFS = [
        {id:"firstClick", title:"–ü–µ—Ä–≤—ã–π —à–∞–≥",  desc:"–°–¥–µ–ª–∞–π –ø–µ—Ä–≤—ã–π –∫–ª–∏–∫",           target:1,   type:"clicks"},
        {id:"clicks500",  title:"–ö–ª–∏–∫–µ—Ä",      desc:"–°–¥–µ–ª–∞–π 500 –∫–ª–∏–∫–æ–≤",            target:500, type:"clicks"},
        {id:"rich10k",    title:"–ü–µ—Ä–≤–∞—è –¥–µ—Å—è—Ç–∫–∞", desc:"–ó–∞—Ä–∞–±–æ—Ç–∞–π —Å—É–º–º–∞—Ä–Ω–æ 10 000", target:10000,type:"earned"},
        {id:"auto50",     title:"–ü–∞—Å—Å–∏–≤–Ω—ã–π –±–æ–≥",   desc:"–î–æ—Å—Ç–∏–≥–Ω–∏ 50 –º–æ–Ω–µ—Ç/—Å–µ–∫",    target:50,  type:"auto"},
    ];

    const DEFAULT_STATE = {
        coins: 0,
        clickLevel: 1,
        clickValue: 1,
        energyLevel: 1,
        maxEnergy: 10,
        energy: 10,
        autoLevel: 1,
        regenLevel: 1,
        energyRegenRate: 1.0,
        lastEnergyAt: Date.now(),
        lastIncomeAt: Date.now(),
        farms: FARM_DEFS.map(f => ({id:f.id, level:0})),
        clickCount: 0,
        totalEarned: 0,
        quests: QUEST_DEFS.reduce((a,q)=>{a[q.id]={claimed:false};return a;},{}),
        achievements: ACH_DEFS.reduce((a,x)=>{a[x.id]={unlocked:false};return a;},{}),
        level: 1,
        steam_rub: 0
    };

    let state = {...DEFAULT_STATE};

    function formatNumber(n){return n.toLocaleString("ru-RU");}

    // === API ===
    async function loadStateFromServer(){
        try{
            const res = await fetch(`${API_BASE}/state/${userId}`);
            if(!res.ok) throw new Error("bad");
            const data = await res.json();
            state = {...DEFAULT_STATE, ...data};
        }catch(e){
            console.warn("load error, fallback default", e);
            state = {...DEFAULT_STATE};
        }
    }

    async function saveStateToServer(){
        try{
            await fetch(`${API_BASE}/state`,{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({user_id:userId, state})
            });
        }catch(e){
            console.warn("save error",e);
        }
    }

    function getClickUpgradeCost(){return Math.round(50*Math.pow(1.5,state.clickLevel-1));}
    function getEnergyUpgradeCost(){return Math.round(75*Math.pow(1.5,state.energyLevel-1));}
    function getAutoUpgradeCost(){return Math.round(100*Math.pow(1.6,state.autoLevel-1));}
    function getRegenUpgradeCost(){return Math.round(120*Math.pow(1.6,state.regenLevel-1));}
    function getLevelUpgradeCost(){
        if(state.level === 1) return 1000;
        if(state.level === 2) return 10_000;
        return Math.round(10_000 * Math.pow(3, state.level-2)); // –¥–∞–ª—å—à–µ —Å–∏–ª—å–Ω–æ –¥–æ—Ä–æ–∂–µ
    }

    function getFarmState(id){
        const f = state.farms.find(x=>x.id===id);
        if(!f){const nf={id,level:0};state.farms.push(nf);return nf;}
        return f;
    }
    function getFarmCost(def){
        const fs = getFarmState(def.id);
        return Math.round(def.baseCost * Math.pow(1.7, fs.level));
    }
    function getFarmIncome(){
        let sum=0;
        for(const def of FARM_DEFS){
            const fs = getFarmState(def.id);
            sum += fs.level * def.baseIncome;
        }
        return sum;
    }
    function getAutoIncome(){return state.autoLevel + getFarmIncome();}

    function regenEnergy(now){
        const deltaSec=(now-state.lastEnergyAt)/1000;
        if(deltaSec<=0)return;
        const add=Math.floor(deltaSec*state.energyRegenRate);
        if(add>0){
            state.energy=Math.min(state.maxEnergy,state.energy+add);
            state.lastEnergyAt+= (add/state.energyRegenRate)*1000;
        }
    }
    function autoIncomeTick(now){
        const deltaSec=(now-state.lastIncomeAt)/1000;
        if(deltaSec<=0)return;
        const secPass=Math.floor(deltaSec);
        if(secPass>0){
            const incomePerSec=getAutoIncome();
            const add=secPass*incomePerSec;
            state.coins+=add;
            state.totalEarned+=add;
            state.lastIncomeAt+=secPass*1000;
        }
    }

    function toggleBtn(btn, ok){
        if(ok) btn.classList.remove("disabled");
        else btn.classList.add("disabled");
    }

    function getAchProgress(ach){
        if(ach.type==="clicks") return Math.min(state.clickCount, ach.target);
        if(ach.type==="earned") return Math.min(state.totalEarned, ach.target);
        if(ach.type==="auto")   return Math.min(getAutoIncome(), ach.target);
        return 0;
    }
    function isAchCompleted(a){return getAchProgress(a)>=a.target;}

    function renderAchievements(){
        achList.innerHTML="";
        for(const a of ACH_DEFS){
            const st = state.achievements[a.id] || {unlocked:false};
            const item=document.createElement("div");
            item.className="ach-item";

            const main=document.createElement("div");
            main.className="ach-main";

            const title=document.createElement("div");
            title.className="ach-title";
            title.textContent=a.title;

            const desc=document.createElement("div");
            desc.className="ach-desc";
            desc.textContent=a.desc;

            const meta=document.createElement("div");
            meta.className="ach-meta";
            const pr=getAchProgress(a);
            meta.textContent=`${formatNumber(pr)} / ${formatNumber(a.target)}`;

            const badge=document.createElement("div");
            badge.className="ach-badge";
            const done=isAchCompleted(a);
            if(done){badge.classList.add("done");badge.textContent="–û—Ç–∫—Ä—ã—Ç–æ";}
            else badge.textContent="–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ";

            const pb=document.createElement("div");
            pb.className="progress";
            const fill=document.createElement("div");
            fill.className="progress-fill";
            const ratio=Math.max(0,Math.min(1,pr/a.target));
            fill.style.width=(ratio*100)+"%";
            pb.appendChild(fill);

            main.appendChild(title);main.appendChild(desc);main.appendChild(meta);main.appendChild(pb);
            item.appendChild(main);item.appendChild(badge);
            achList.appendChild(item);

            st.unlocked=done;
            state.achievements[a.id]=st;
        }
    }

    function getQuestProgress(q){
        if(q.type==="clicks") return Math.min(state.clickCount,q.target);
        if(q.type==="coins")  return Math.min(state.coins,q.target);
        if(q.type==="auto")   return Math.min(getAutoIncome(),q.target);
        return 0;
    }
    function isQuestCompleted(q){return getQuestProgress(q)>=q.target;}

    function renderQuestPanel(){
        questList.innerHTML="";
        for(const q of QUEST_DEFS){
            const s=state.quests[q.id] || {claimed:false};
            const item=document.createElement("div");
            item.className="quest-item";

            const main=document.createElement("div");
            main.className="quest-main";

            const title=document.createElement("div");
            title.className="quest-title";
            title.textContent=q.title;

            const desc=document.createElement("div");
            desc.className="quest-desc";
            desc.textContent=q.desc;

            const meta=document.createElement("div");
            meta.className="quest-meta";
            const pr=getQuestProgress(q);
            meta.textContent=`–ù–∞–≥—Ä–∞–¥–∞: ${formatNumber(q.reward)} ¬∑ ${formatNumber(pr)} / ${formatNumber(q.target)}`;

            const pb=document.createElement("div");
            pb.className="progress";
            const fill=document.createElement("div");
            fill.className="progress-fill";
            const ratio=Math.max(0,Math.min(1,pr/q.target));
            fill.style.width=(ratio*100)+"%";
            pb.appendChild(fill);

            main.appendChild(title);main.appendChild(desc);main.appendChild(meta);main.appendChild(pb);

            const btn=document.createElement("button");
            btn.className="btn-pill";
            const done=isQuestCompleted(q);

            if(s.claimed){btn.textContent="–ü–æ–ª—É—á–µ–Ω–æ";btn.classList.add("disabled");}
            else if(done){
                btn.textContent="–ó–∞–±—Ä–∞—Ç—å";
                btn.addEventListener("click",()=>{
                    if(state.quests[q.id].claimed) return;
                    state.quests[q.id].claimed=true;
                    state.coins+=q.reward;
                    state.totalEarned+=q.reward;
                    updateUI(); saveStateToServer();
                });
            }else{
                btn.textContent="–í –ø—Ä–æ—Ü–µ—Å—Å–µ";btn.classList.add("disabled");
            }

            item.appendChild(main);item.appendChild(btn);
            questList.appendChild(item);
            state.quests[q.id]=s;
        }
    }

    function renderFarmPanel(){
        farmList.innerHTML="";
        for(const def of FARM_DEFS){
            const fs=getFarmState(def.id);
            const item=document.createElement("div");
            item.className="farm-item";

            const main=document.createElement("div");
            main.className="farm-main";

            const title=document.createElement("div");
            title.className="farm-title";
            title.textContent=def.title;

            const desc=document.createElement("div");
            desc.className="farm-desc";
            desc.textContent=def.desc;

            const meta=document.createElement("div");
            meta.className="farm-meta";
            meta.textContent=`–£—Ä–æ–≤–µ–Ω—å ${fs.level} ¬∑ ${fs.level*def.baseIncome} –≤ —Å–µ–∫—É–Ω–¥—É`;

            main.appendChild(title);main.appendChild(desc);main.appendChild(meta);

            const btn=document.createElement("button");
            btn.className="btn-pill";
            const cost=getFarmCost(def);
            btn.textContent=`–ö—É–ø–∏—Ç—å ¬∑ ${formatNumber(cost)}`;
            toggleBtn(btn,state.coins>=cost);

            btn.addEventListener("click",()=>{
                if(state.coins<cost)return;
                state.coins-=cost;
                fs.level+=1;
                updateUI(); saveStateToServer();
            });

            item.appendChild(main);item.appendChild(btn);
            farmList.appendChild(item);
        }
    }

    function updateSteamMeta(){
        const rate = 10_000_000;
        const availableRub = Math.floor(state.coins / rate);
        const canWithdraw = availableRub >= 100;
        steamMeta.textContent = `–ë–∞–ª–∞–Ω—Å Steam: ${state.steam_rub}‚ÇΩ ¬∑ –¥–æ—Å—Ç—É–ø–Ω–æ ${availableRub}‚ÇΩ`;
        toggleBtn(btnSteamCashout, canWithdraw);
    }

    function updateRefLink(){
        const link = `https://t.me/${BOT_USERNAME}?start=ref_${userId}`;
        refLinkEl.textContent = link;
    }

    function updateUI(){
        const autoIncome = getAutoIncome();
        coinsLabel.textContent = formatNumber(state.coins);
        incomeLabel.textContent = `${state.clickValue} –∑–∞ –∫–ª–∏–∫ ¬∑ ${autoIncome} –≤ —Å–µ–∫—É–Ω–¥—É`;
        greenInfo.textContent  = `${state.clickValue} –∑–∞ –∫–ª–∏–∫ ¬∑ ${autoIncome} –≤ —Å–µ–∫—É–Ω–¥—É`;

        energyLabel.textContent = `${state.energy} / ${state.maxEnergy}`;
        energyFill.style.width = `${(state.energy/state.maxEnergy)*100}%`;

        toggleBtn(clickBtn, state.energy>0);

        levelLabel.textContent = state.level;
        const nextCost = getLevelUpgradeCost();
        levelMeta.textContent = `–£—Ä–æ–≤–µ–Ω—å ${state.level} ¬∑ —Å–ª–µ–¥. ${formatNumber(nextCost)} –º–æ–Ω–µ—Ç`;

        energyMeta.textContent = `–£—Ä–æ–≤–µ–Ω—å ${state.energyLevel} ¬∑ ${state.maxEnergy} —ç–Ω–µ—Ä–≥–∏–∏`;
        clickMeta.textContent  = `–£—Ä–æ–≤–µ–Ω—å ${state.clickLevel} ¬∑ ${state.clickValue} –∑–∞ –∫–ª–∏–∫`;
        autoMeta.textContent   = `–£—Ä–æ–≤–µ–Ω—å ${state.autoLevel} ¬∑ ${state.autoLevel} –±–∞–∑–æ–≤—ã–π –∞–≤—Ç–æ-–∫–ª–∏–∫`;
        regenMeta.textContent  = `–£—Ä–æ–≤–µ–Ω—å ${state.regenLevel} ¬∑ ${state.energyRegenRate.toFixed(1)} ‚ö°/—Å–µ–∫`;

        const costE = getEnergyUpgradeCost();
        const costC = getClickUpgradeCost();
        const costA = getAutoUpgradeCost();
        const costR = getRegenUpgradeCost();
        const costL = getLevelUpgradeCost();

        btnUpgEnergy.textContent = `–ö—É–ø–∏—Ç—å ¬∑ ${formatNumber(costE)}`;
        btnUpgClick.textContent  = `–ö—É–ø–∏—Ç—å ¬∑ ${formatNumber(costC)}`;
        btnUpgAuto.textContent   = `–ö—É–ø–∏—Ç—å ¬∑ ${formatNumber(costA)}`;
        btnUpgRegen.textContent  = `–ö—É–ø–∏—Ç—å ¬∑ ${formatNumber(costR)}`;
        btnUpgLevel.textContent  = `–ü–æ–≤—ã—Å–∏—Ç—å ¬∑ ${formatNumber(costL)}`;

        toggleBtn(btnUpgEnergy, state.coins>=costE);
        toggleBtn(btnUpgClick,  state.coins>=costC);
        toggleBtn(btnUpgAuto,   state.coins>=costA);
        toggleBtn(btnUpgRegen,  state.coins>=costR);
        toggleBtn(btnUpgLevel,  state.coins>=costL);

        renderFarmPanel();
        renderQuestPanel();
        renderAchievements();
        updateSteamMeta();
        updateRefLink();
    }

    function spawnFloatText(amount){
        const el=document.createElement("div");
        el.className="float-coin";
        el.textContent=`+${amount}`;
        const x=Math.random()*0.6+0.2;
        const y=Math.random()*0.4+0.3;
        el.style.left=(x*100)+"%";
        el.style.top=(y*100)+"%";
        el.style.transform="translate(-50%, -50%)";
        hamsterWrapper.appendChild(el);
        el.addEventListener("animationend",()=>el.remove());
    }
    function hitHamster(){
        hamsterWrapper.classList.add("hit");
        setTimeout(()=>hamsterWrapper.classList.remove("hit"),100);
    }

    clickBtn.addEventListener("click",()=>{
        const now=Date.now();
        regenEnergy(now); autoIncomeTick(now);
        if(state.energy<=0){updateUI();return;}
        state.energy-=1;
        state.coins+=state.clickValue;
        state.clickCount+=1;
        state.totalEarned+=state.clickValue;
        hitHamster(); spawnFloatText(state.clickValue);
        updateUI(); saveStateToServer();
    });

    btnUpgEnergy.addEventListener("click",()=>{
        const cost=getEnergyUpgradeCost();
        if(state.coins<cost)return;
        state.coins-=cost;
        state.energyLevel+=1;
        state.maxEnergy+=5;
        state.energy=state.maxEnergy;
        updateUI(); saveStateToServer();
    });
    btnUpgClick.addEventListener("click",()=>{
        const cost=getClickUpgradeCost();
        if(state.coins<cost)return;
        state.coins-=cost;
        state.clickLevel+=1;
        state.clickValue+=1;
        updateUI(); saveStateToServer();
    });
    btnUpgAuto.addEventListener("click",()=>{
        const cost=getAutoUpgradeCost();
        if(state.coins<cost)return;
        state.coins-=cost;
        state.autoLevel+=1;
        updateUI(); saveStateToServer();
    });
    btnUpgRegen.addEventListener("click",()=>{
        const cost=getRegenUpgradeCost();
        if(state.coins<cost)return;
        state.coins-=cost;
        state.regenLevel+=1;
        state.energyRegenRate+=0.25;
        updateUI(); saveStateToServer();
    });
    btnUpgLevel.addEventListener("click",()=>{
        const cost=getLevelUpgradeCost();
        if(state.coins<cost)return;
        state.coins-=cost;
        state.level+=1;
        updateUI(); saveStateToServer();
    });

    btnSteamCashout.addEventListener("click",()=>{
        const rate=10_000_000;
        const availableRub=Math.floor(state.coins / rate);
        if(availableRub<100) return;
        const rubles=availableRub; // –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫—Ä–∞—Ç–Ω–æ 100, –Ω–æ —Å–µ–π—á–∞—Å –≤—Å—ë
        state.coins -= rubles*rate;
        state.steam_rub += rubles;
        updateUI(); saveStateToServer();
        if(tg){
            tg.showAlert(`–ó–∞—á–∏—Å–ª–µ–Ω–æ ${rubles}‚ÇΩ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π Steam-–±–∞–ª–∞–Ω—Å.\n(–≠—Ç–æ –ø–æ–∫–∞ –∏–≥—Ä–æ–≤–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞, —Ä–µ–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ –Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ.)`);
        }
    });

    function switchTab(tab){
        tabButtons.forEach(b=>b.classList.toggle("active",b.dataset.tab===tab));
        Object.keys(panels).forEach(k=>{
            panels[k].classList.toggle("hidden",k!==tab);
        });
        hamsterZone.style.display = (tab==="upgrades") ? "flex" : "none";
    }
    tabButtons.forEach(btn=>btn.addEventListener("click",()=>switchTab(btn.dataset.tab)));
    backButtons.forEach(btn=>btn.addEventListener("click",()=>switchTab(btn.dataset.back || "upgrades")));

    function gameLoop(){
        const now=Date.now();
        regenEnergy(now); autoIncomeTick(now);
        updateUI(); saveStateToServer();
    }

    (async ()=>{
        await loadStateFromServer();
        updateUI();
        setInterval(gameLoop,500);
    })();
</script>
</body>
</html>
